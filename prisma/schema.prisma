generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(cuid())
  walletAddress       String    @unique
  selectedAnimal      String?
  petName             String?
  userName            String?
  userAge             String?
  diaryGoal           String?
  onboardingCompleted Boolean   @default(false)
  coinsBalance        Int       @default(0)
  livesRemaining      Int       @default(7)
  currentStreak       Int       @default(0)
  longestStreak       Int       @default(0)
  lastEntryDate       DateTime?
  lastActiveAt        DateTime  @default(now())
  lastLifeLossCheck   DateTime  @default(now())
  aiAnalysisEnabled   Boolean   @default(false)
  activeBackground    String?
  activeAccessory     String?

  // Tamagotchi features
  happiness           Int       @default(100)
  petState            String    @default("idle")
  petPersonality      Json?     // {energyLevel: 'hyper', favoriteFood: 'meat', sleepSchedule: 'night'}
  lastFeedTime        DateTime?
  lastPlayTime        DateTime?
  inventory           Json?     // {timeSkip: 2, healthPotion: 1, happyPill: 3}

  // Agent & viral features
  referralCode     String?   @unique
  referredBy       String?
  isAgent          Boolean   @default(false)
  rarePets         String[]  // ["lobster", "phoenix", ...]
  authToken        String?
  authTokenExpiry  DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  entries         Entry[]
  purchases       Purchase[]
  rewards         Reward[]
  weeklySummaries WeeklySummary[]

  @@index([walletAddress])
}

model Entry {
  id                String   @id @default(cuid())
  userId            String
  encryptedContent  String   @db.Text
  signature         String
  contentHash       String
  wordCount         Int      @default(0)
  date              DateTime @default(now())
  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  itemType    String
  itemId      String
  price       Int
  txHash      String?
  purchasedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Reward {
  id          String   @id @default(cuid())
  userId      String
  type        String
  amount      Int
  description String
  txHash      String
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ShopItem {
  id          String  @id @default(cuid())
  type        String
  name        String
  description String?
  price       Int
  imageUrl    String
  available   Boolean @default(true)
  sortOrder   Int     @default(0)
}

model WeeklySummary {
  id        String   @id @default(cuid())
  userId    String
  weekStart DateTime
  weekEnd   DateTime

  // Plutchik's 8 emotions (0-100%)
  emotions  Json     // {joy: 45, trust: 60, fear: 20, surprise: 30, sadness: 15, disgust: 10, anger: 25, anticipation: 50}

  summary   String   @db.Text
  insights  String[] // Array of key insights
  trend     String   // "improving" | "stable" | "declining"

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId])
}

model WallPost {
  id        String     @id @default(cuid())
  text      String     @db.Text
  tags      String[]
  petName   String?
  petType   String
  petState  String
  streak    Int        @default(0)
  isRarePet Boolean    @default(false)
  likes     Int        @default(0)
  entryId   String?
  createdAt DateTime   @default(now())

  wallLikes WallLike[]

  @@index([createdAt])
  @@index([likes])
}

model WallLike {
  id          String   @id @default(cuid())
  postId      String
  fingerprint String
  createdAt   DateTime @default(now())

  post WallPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, fingerprint])
  @@index([postId])
}

model Feedback {
  id             String   @id @default(cuid())
  walletAddress  String?
  isAgent        Boolean  @default(false)
  type           String   // "bug" | "feature" | "general" | "love"
  message        String   @db.Text
  contact        String?  // optional email/twitter
  createdAt      DateTime @default(now())

  @@index([createdAt])
}
